

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>framework.Optimization.objective_function_real &mdash; sphinx-multimodule-docexample u&#39;0.0.1&#39; documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> sphinx-multimodule-docexample
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">sphinx-multimodule-docexample</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>framework.Optimization.objective_function_real</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for framework.Optimization.objective_function_real</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">File name : Network profit function</span>
<span class="sd">Authors   : Alejandro Rios</span>
<span class="sd">Email     : aarc.88@gmail.com</span>
<span class="sd">Date      : July 2020</span>
<span class="sd">Last edit : February 2021</span>
<span class="sd">Language  : Python 3.8 or &gt;</span>
<span class="sd">Aeronautical Institute of Technology - Airbus Brazil</span>

<span class="sd">Description:</span>
<span class="sd">    - This module calculates the network profit following the following steps:</span>
<span class="sd">        - Vehicle sizing and checks (airplane_sizing)</span>
<span class="sd">        - Revenue calculation (reveneu)</span>
<span class="sd">        - Direct operational cost calculation (mission)</span>
<span class="sd">        - Profit calculation (network_optimization)</span>

<span class="sd">Inputs:</span>
<span class="sd">    - Optimization variables (array x)</span>
<span class="sd">    - Mutable dictionary with aircraft, perfomance, operations and airports</span>
<span class="sd">    departure and destiny information</span>
<span class="sd">Outputs:</span>
<span class="sd">    - Profit wich is the objective function</span>
<span class="sd">TODO&#39;s:</span>
<span class="sd">    -</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># IMPORTS</span>
<span class="c1"># =============================================================================</span>

<span class="kn">from</span> <span class="nn">framework.Performance.Mission.mission_real</span> <span class="kn">import</span> <span class="n">mission</span>
<span class="kn">from</span> <span class="nn">framework.Network.network_optimization</span> <span class="kn">import</span> <span class="n">network_optimization</span><span class="p">,</span><span class="n">network_optimization_fix</span>
<span class="kn">from</span> <span class="nn">framework.Economics.revenue</span> <span class="kn">import</span> <span class="n">revenue</span>
<span class="kn">from</span> <span class="nn">framework.Sizing.airplane_sizing_check</span> <span class="kn">import</span> <span class="n">airplane_sizing</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">framework.utilities.logger</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">framework.utilities.output</span> <span class="kn">import</span> <span class="n">write_optimal_results</span><span class="p">,</span> <span class="n">write_kml_results</span><span class="p">,</span> <span class="n">write_bad_results</span><span class="p">,</span> <span class="n">write_newtork_results</span><span class="p">,</span> <span class="n">write_unfeasible_results</span>

<span class="kn">from</span> <span class="nn">framework.Attributes.Geo.bearing</span> <span class="kn">import</span> <span class="n">calculate_bearing</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># CLASSES</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># FUNCTIONS</span>
<span class="c1"># =============================================================================</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__file__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="objective_function_0"><a class="viewcode-back" href="../../../framework.Optimization.html#framework.Optimization.objective_function_real.objective_function_0">[docs]</a><span class="k">def</span> <span class="nf">objective_function_0</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==== Start network profit module ====&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Try running profit calculation. If error appears during run profit = 0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># Airplane sizing and checks</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">vehicle</span> <span class="o">=</span> <span class="n">airplane_sizing</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># status = 0</span>
            <span class="c1"># flags = [0,0,0]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; airplane_sizing&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;operations&#39;</span><span class="p">]</span>
        <span class="n">airport_departure</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;airport_departure&#39;</span><span class="p">]</span>
        <span class="n">airport_destination</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;airport_destination&#39;</span><span class="p">]</span>
        <span class="n">aircraft</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
        <span class="n">data_airports</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Database/Airports/airports.csv&quot;</span><span class="p">)</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># If airplane pass checks, status = 0, else status = 1 and profit = 0</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft passed sizing and checks status: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>

            <span class="n">market_share</span> <span class="o">=</span> <span class="n">operations</span><span class="p">[</span><span class="s1">&#39;market_share&#39;</span><span class="p">]</span>

            <span class="c1"># Load origin-destination distance matrix [nm]</span>
            <span class="n">distances_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Distance/distance.csv&#39;</span><span class="p">)</span>
            <span class="n">distances_db</span> <span class="o">=</span> <span class="n">distances_db</span><span class="o">.</span><span class="n">T</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">distances_db</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Convert to dictionaty</span>

            <span class="c1"># Load daily demand matrix and multiply by market share (10%)</span>
            <span class="n">demand_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Demand/demand.csv&#39;</span><span class="p">)</span>
            <span class="n">demand_db</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">market_share</span><span class="o">*</span><span class="p">(</span><span class="n">demand_db</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">demand0</span> <span class="o">=</span> <span class="n">demand_db</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="c1"># Load daily demand matrix and multiply by market share (10%)</span>
            <span class="n">active_airports_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Demand/switch_matrix_full.csv&#39;</span><span class="p">)</span>
            <span class="n">active_airports_db</span> <span class="o">=</span> <span class="n">active_airports_db</span><span class="o">.</span><span class="n">T</span>
            <span class="n">active_airports</span> <span class="o">=</span> <span class="n">active_airports_db</span> <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="n">pax_capacity</span> <span class="o">=</span> <span class="n">aircraft</span><span class="p">[</span><span class="s1">&#39;passenger_capacity&#39;</span><span class="p">]</span>  <span class="c1"># Passenger capacity</span>

            <span class="c1"># Airports:</span>
            <span class="c1"># [&quot;FRA&quot;, &quot;LHR&quot;, &quot;CDG&quot;, &quot;AMS&quot;,</span>
            <span class="c1">#          &quot;MAD&quot;, &quot;BCN&quot;, &quot;FCO&quot;,&quot;DUB&quot;,&quot;VIE&quot;,&quot;ZRH&quot;]</span>
            <span class="n">departures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD0&#39;</span><span class="p">,</span><span class="s1">&#39;CD1&#39;</span><span class="p">,</span><span class="s1">&#39;CD2&#39;</span><span class="p">,</span><span class="s1">&#39;CD3&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;CD4&#39;</span><span class="p">,</span><span class="s1">&#39;CD5&#39;</span><span class="p">,</span><span class="s1">&#39;CD6&#39;</span><span class="p">,</span><span class="s1">&#39;CD7&#39;</span><span class="p">,</span><span class="s1">&#39;CD8&#39;</span><span class="p">,</span><span class="s1">&#39;CD9&#39;</span><span class="p">]</span>
            <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD0&#39;</span><span class="p">,</span><span class="s1">&#39;CD1&#39;</span><span class="p">,</span><span class="s1">&#39;CD2&#39;</span><span class="p">,</span><span class="s1">&#39;CD3&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;CD4&#39;</span><span class="p">,</span><span class="s1">&#39;CD5&#39;</span><span class="p">,</span><span class="s1">&#39;CD6&#39;</span><span class="p">,</span><span class="s1">&#39;CD7&#39;</span><span class="p">,</span><span class="s1">&#39;CD8&#39;</span><span class="p">,</span><span class="s1">&#39;CD9&#39;</span><span class="p">]</span>

            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_airports</span><span class="p">)</span>

            <span class="n">demand</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)):</span>
                <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">active_airports</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">demand0</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># =============================================================================</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- Start DOC matrix calculation ----&#39;</span><span class="p">)</span>
            <span class="c1"># The DOC is estimated for each city pair and stored in the DOC dictionary</span>
            <span class="n">city_matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span>
            <span class="n">DOC_ik</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">distances_ik</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">DOC_nd</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fuel_mass</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">total_mission_flight_time</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mach</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">passenger_capacity</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">SAR</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)):</span>

                    <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">distances_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]):</span>

                            <span class="c1"># Update information about orign-destination pair airports:</span>

                            <span class="c1"># Elevation:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                            <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;ELEV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;ELEV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Field length:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;takeoff_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                        <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;TORA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;takeoff_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;TORA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Landing field length</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;landing_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                        <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;LDA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;landing_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                        <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;LDA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                                                                            
                            <span class="c1"># Average delay:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;avg_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;AVD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;avg_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;AVA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Delta ISA</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;delta_ISA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;TREF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;delta_ISA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;TREF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="c1"># Heading                                                          </span>
                            <span class="n">bearing</span> <span class="o">=</span> <span class="n">calculate_bearing</span><span class="p">((</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LAT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LON&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),(</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LAT&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LON&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                            <span class="n">heading</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">bearing</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;DMG&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;DMG&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">heading</span> <span class="o">=</span> <span class="n">heading</span> <span class="o">+</span> <span class="mi">360</span>

                            <span class="c1"># Calculate DOC and mission parameters for origin-destination airports pair:                        </span>

                            <span class="c1"># mission_range = distances[departures[i]][arrivals[k]]</span>
                            <span class="n">departures_in</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;APT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">arrivals_in</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;APT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">DOC</span> <span class="p">,</span><span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span><span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">mission_range</span><span class="o">=</span> <span class="n">mission</span><span class="p">(</span><span class="n">departures_in</span><span class="p">,</span><span class="n">arrivals_in</span><span class="p">,</span><span class="n">heading</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                            <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">DOC</span>
                            <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">DOC</span><span class="o">*</span><span class="n">distances</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                            <span class="n">distances_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mission_range</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1e10</span>

                            <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">city_matrix_size</span> <span class="o">=</span> <span class="n">city_matrix_size</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO &gt;&gt;&gt;&gt; city pairs remaining to finish DOC matrix fill: &#39;</span><span class="p">,</span><span class="n">city_matrix_size</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- End DOC matrix calculation ----&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; DOC matrix generation&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Database/DOC/DOC.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">DOC_ik</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">DOC_ik</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>


            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft DOC matrix: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DOC_ik</span><span class="p">))</span>
            <span class="c1"># =============================================================================</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- Start Network Optimization ----&#39;</span><span class="p">)</span>
            <span class="c1"># Network optimization that maximizes the network profit</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">profit</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">kpi_df1</span><span class="p">,</span> <span class="n">kpi_df2</span> <span class="o">=</span> <span class="n">network_optimization</span><span class="p">(</span>
                        <span class="n">arrivals</span><span class="p">,</span> <span class="n">departures</span><span class="p">,</span> <span class="n">distances_ik</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span><span class="n">active_airports</span> <span class="p">,</span><span class="n">DOC_ik</span><span class="p">,</span> <span class="n">pax_capacity</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; network_optimization&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network profit [$USD]: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>
            <span class="c1"># =============================================================================</span>

            <span class="k">def</span> <span class="nf">flatten_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">k</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="n">prefix</span> <span class="p">:</span> <span class="n">dd</span> <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">mach_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">mach</span><span class="p">)</span>
                <span class="n">mach_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mach_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">])</span>
                <span class="n">passenger_capacity_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">passenger_capacity</span><span class="p">)</span>
                <span class="n">passenger_capacity_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">passenger_capacity_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">])</span>
                <span class="n">fuel_used_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">fuel_mass</span><span class="p">)</span>
                <span class="n">fuel_used_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fuel_used_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">])</span>
                <span class="n">mission_time_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">total_mission_flight_time</span><span class="p">)</span>
                <span class="n">mission_time_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mission_time_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                <span class="n">DOC_nd_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">DOC_nd</span><span class="p">)</span>
                <span class="n">DOC_nd_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DOC_nd_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">])</span>
                <span class="n">SAR_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span>
                <span class="n">SAR_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SAR_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span>

                <span class="n">distances_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
                <span class="n">kpi_df3</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">distances_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;distances01&#39;</span><span class="p">])</span>

                <span class="n">mach_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">mach</span><span class="p">)</span>
                <span class="n">mach_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mach_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">])</span>
                <span class="n">passenger_capacity_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">passenger_capacity</span><span class="p">)</span>
                <span class="n">passenger_capacity_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">passenger_capacity_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">])</span>
                <span class="n">fuel_used_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">fuel_mass</span><span class="p">)</span>
                <span class="n">fuel_used_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fuel_used_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">])</span>
                <span class="n">mission_time_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">total_mission_flight_time</span><span class="p">)</span>
                <span class="n">mission_time_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mission_time_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                <span class="n">DOC_nd_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">DOC_nd</span><span class="p">)</span>
                <span class="n">DOC_nd_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DOC_nd_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">])</span>
                <span class="n">SAR_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span>
                <span class="n">SAR_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SAR_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span>


                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mach_df</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passenger_capacity_df</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fuel_used_df</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mission_time_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DOC_nd_df</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_df</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="n">kpi_df3</span><span class="o">=</span> <span class="n">kpi_df3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">kpi_df3</span><span class="p">[</span><span class="n">kpi_df3</span><span class="o">.</span><span class="n">distances01</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">kpi_df3</span> <span class="o">=</span> <span class="n">kpi_df3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">kpi_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">kpi_df2</span><span class="p">,</span><span class="n">kpi_df3</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
 
                <span class="c1"># Number of active nodes</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;active_arcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s2">&quot;aircraft_number&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;arcs_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;active_arcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="c1"># Number of aircraft</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Average cruise mach</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;mach_tot_aircraft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span>
                <span class="c1"># Total fuel</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_fuel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span>
                <span class="c1"># total CEMV</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_CEMV&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">aircraft</span><span class="p">[</span><span class="s1">&#39;wetted_area&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">0.24</span><span class="p">)))</span>
                <span class="c1"># Total distance</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span>
                <span class="c1"># Total pax</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_pax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span>
                <span class="c1"># Total cost</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;network_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;arcs_number&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">])</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; writting dataframes&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_optimal_results</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span> <span class="n">DOC_ik</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">kpi_df2</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_optimal_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_kml_results</span><span class="p">(</span><span class="n">arrivals</span><span class="p">,</span> <span class="n">departures</span><span class="p">,</span> <span class="n">profit</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_kml_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_newtork_results</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span><span class="n">kpi_df1</span><span class="p">,</span><span class="n">kpi_df2</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_newtork_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">write_unfeasible_results</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Aircraft did not pass sizing and checks, profit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>

            
    <span class="k">except</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; objective_function&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exception ocurred during calculations&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft not passed sizing and checks, profit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_bad_results</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_bad_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final individual results is:&quot;</span><span class="p">,</span> <span class="n">profit</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing finally clause&quot;</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network profit excecution time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==== End network profit module ====&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profit</span></div>

<div class="viewcode-block" id="objective_function_1"><a class="viewcode-back" href="../../../framework.Optimization.html#framework.Optimization.objective_function_real.objective_function_1">[docs]</a><span class="k">def</span> <span class="nf">objective_function_1</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==== Start network profit module ====&#39;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Try running profit calculation. If error appears during run profit = 0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># Airplane sizing and checks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">vehicle</span> <span class="o">=</span> <span class="n">airplane_sizing</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># status = 0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; airplane_sizing&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span>
        <span class="n">operations</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;operations&#39;</span><span class="p">]</span>
        <span class="n">airport_departure</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;airport_departure&#39;</span><span class="p">]</span>
        <span class="n">airport_destination</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;airport_destination&#39;</span><span class="p">]</span>
        <span class="n">aircraft</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
        <span class="n">data_airports</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;Database/Airports/airports.csv&quot;</span><span class="p">)</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># If airplane pass checks, status = 0, else status = 1 and profit = 0</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft passed sizing and checks status: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>

            <span class="n">market_share</span> <span class="o">=</span> <span class="n">operations</span><span class="p">[</span><span class="s1">&#39;market_share&#39;</span><span class="p">]</span>

            <span class="c1"># Load origin-destination distance matrix [nm]</span>
            <span class="n">distances_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Distance/distance.csv&#39;</span><span class="p">)</span>
            <span class="n">distances_db</span> <span class="o">=</span> <span class="n">distances_db</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="n">distances_db</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Convert to dictionaty</span>

            <span class="c1"># Load daily demand matrix and multiply by market share (10%)</span>
            <span class="n">demand_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Demand/demand.csv&#39;</span><span class="p">)</span>
            <span class="n">demand_db</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">market_share</span><span class="o">*</span><span class="p">(</span><span class="n">demand_db</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">demand0</span> <span class="o">=</span> <span class="n">demand_db</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="c1"># Load daily demand matrix and multiply by market share (10%)</span>
            <span class="n">active_airports_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;Database/Demand/switch_matrix.csv&#39;</span><span class="p">)</span>
            <span class="n">active_airports_db</span> <span class="o">=</span> <span class="n">active_airports_db</span><span class="o">.</span><span class="n">T</span>
            <span class="n">active_airports</span> <span class="o">=</span> <span class="n">active_airports_db</span> <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="n">pax_capacity</span> <span class="o">=</span> <span class="n">aircraft</span><span class="p">[</span><span class="s1">&#39;passenger_capacity&#39;</span><span class="p">]</span>  <span class="c1"># Passenger capacity</span>

            <span class="c1"># Airports:</span>
            <span class="c1"># [&quot;FRA&quot;, &quot;LHR&quot;, &quot;CDG&quot;, &quot;AMS&quot;,</span>
            <span class="c1">#          &quot;MAD&quot;, &quot;BCN&quot;, &quot;FCO&quot;,&quot;DUB&quot;,&quot;VIE&quot;,&quot;ZRH&quot;]</span>
            <span class="n">departures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;CD1&#39;</span><span class="p">,</span> <span class="s1">&#39;CD2&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CD4&#39;</span><span class="p">,</span> <span class="s1">&#39;CD5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD6&#39;</span><span class="p">,</span> <span class="s1">&#39;CD7&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;CD9&#39;</span><span class="p">]</span>
            <span class="n">arrivals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CD0&#39;</span><span class="p">,</span> <span class="s1">&#39;CD1&#39;</span><span class="p">,</span> <span class="s1">&#39;CD2&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CD4&#39;</span><span class="p">,</span> <span class="s1">&#39;CD5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD6&#39;</span><span class="p">,</span> <span class="s1">&#39;CD7&#39;</span><span class="p">,</span> <span class="s1">&#39;CD8&#39;</span><span class="p">,</span> <span class="s1">&#39;CD9&#39;</span><span class="p">]</span>

            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_airports</span><span class="p">)</span>
            
            <span class="n">demand</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)):</span>
                <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">active_airports</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">demand0</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">demand</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># departures = [&#39;CD1&#39;, &#39;CD2&#39;, &#39;CD3&#39;, &#39;CD4&#39;]</span>
            <span class="c1"># arrivals = [&#39;CD1&#39;, &#39;CD2&#39;, &#39;CD3&#39;, &#39;CD4&#39;]</span>

            <span class="c1"># =============================================================================</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- Start DOC matrix calculation ----&#39;</span><span class="p">)</span>
            <span class="c1"># The DOC is estimated for each city pair and stored in the DOC dictionary</span>
            <span class="n">city_matrix_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)</span>
            <span class="n">DOC_ik</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">DOC_nd</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">fuel_mass</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">total_mission_flight_time</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mach</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">passenger_capacity</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">SAR</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">departures</span><span class="p">)):</span>

                    <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">performance</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">active_airports</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>

                            <span class="c1"># Update information about orign-destination pair airports:</span>

                            <span class="c1"># Elevation:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                            <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;ELEV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;ELEV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Field length:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;takeoff_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                        <span class="o">==</span> <span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;TORA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;takeoff_field_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;TORA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Average delay:</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;avg_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;AVD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;avg_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;AVA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="c1"># Delta ISA</span>
                            <span class="n">airport_departure</span><span class="p">[</span><span class="s1">&#39;delta_ISA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;TREF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">airport_destination</span><span class="p">[</span><span class="s1">&#39;delta_ISA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_airports</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;APT2&#39;</span><span class="p">]</span>
                                                                                            <span class="o">==</span> <span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;TREF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                            <span class="c1"># Heading                                                          </span>
                            <span class="n">bearing</span> <span class="o">=</span> <span class="n">calculate_bearing</span><span class="p">((</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LAT&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LON&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),(</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LAT&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;LON&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
                            <span class="n">heading</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">bearing</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;DMG&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_airports</span><span class="p">[</span><span class="s1">&#39;DMG&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">heading</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">heading</span> <span class="o">=</span> <span class="n">heading</span> <span class="o">+</span> <span class="mi">360</span>

                            <span class="c1"># Calculate DOC and mission parameters for origin-destination airports pair:                        </span>
                            <span class="n">mission_range</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                            <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">DOC</span><span class="p">,</span><span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span><span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mission</span><span class="p">(</span><span class="n">mission_range</span><span class="p">,</span><span class="n">heading</span><span class="p">,</span><span class="n">vehicle</span><span class="p">)</span>
                            <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">DOC</span>
                            <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">DOC</span><span class="o">*</span><span class="n">distances</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>                       
                            <span class="c1"># print(DOC_ik[(i, k)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">DOC_nd</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">DOC_ik</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

                            <span class="n">fuel_mass</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">total_mission_flight_time</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">mach</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">passenger_capacity</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>  <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">SAR</span><span class="p">[</span><span class="n">departures</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">arrivals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="n">city_matrix_size</span> <span class="o">=</span> <span class="n">city_matrix_size</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO &gt;&gt;&gt;&gt; city pairs remaining to finish DOC matrix fill: &#39;</span><span class="p">,</span><span class="n">city_matrix_size</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- End DOC matrix calculation ----&#39;</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; DOC matrix generation&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;Database/DOC/DOC.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">DOC_ik</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">DOC_ik</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                    

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft DOC matrix: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DOC_ik</span><span class="p">))</span>
            <span class="c1"># =============================================================================</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- Start Network Optimization ----&#39;</span><span class="p">)</span>
            <span class="c1"># Network optimization that maximizes the network profit</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">profit</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">kpi_df1</span><span class="p">,</span> <span class="n">kpi_df2</span> <span class="o">=</span> <span class="n">network_optimization_fix</span><span class="p">(</span>
                        <span class="n">arrivals</span><span class="p">,</span> <span class="n">departures</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span><span class="n">active_airports</span> <span class="p">,</span><span class="n">DOC_ik</span><span class="p">,</span> <span class="n">pax_capacity</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; network_optimization&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network profit [$USD]: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>
            <span class="c1"># =============================================================================</span>

            <span class="k">def</span> <span class="nf">flatten_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">k</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="n">prefix</span> <span class="p">:</span> <span class="n">dd</span> <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">mach_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">mach</span><span class="p">)</span>
                <span class="n">mach_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mach_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">])</span>
                <span class="n">passenger_capacity_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">passenger_capacity</span><span class="p">)</span>
                <span class="n">passenger_capacity_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">passenger_capacity_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">])</span>
                <span class="n">fuel_used_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">fuel_mass</span><span class="p">)</span>
                <span class="n">fuel_used_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fuel_used_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">])</span>
                <span class="n">mission_time_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">total_mission_flight_time</span><span class="p">)</span>
                <span class="n">mission_time_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mission_time_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                <span class="n">DOC_nd_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">DOC_nd</span><span class="p">)</span>
                <span class="n">DOC_nd_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DOC_nd_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">])</span>
                <span class="n">SAR_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span>
                <span class="n">SAR_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SAR_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span>

                <span class="n">distances_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
                <span class="n">kpi_df3</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">distances_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;distances01&#39;</span><span class="p">])</span>

                <span class="n">mach_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">mach</span><span class="p">)</span>
                <span class="n">mach_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mach_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">])</span>
                <span class="n">passenger_capacity_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">passenger_capacity</span><span class="p">)</span>
                <span class="n">passenger_capacity_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">passenger_capacity_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">])</span>
                <span class="n">fuel_used_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">fuel_mass</span><span class="p">)</span>
                <span class="n">fuel_used_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fuel_used_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">])</span>
                <span class="n">mission_time_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">total_mission_flight_time</span><span class="p">)</span>
                <span class="n">mission_time_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">mission_time_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                <span class="n">DOC_nd_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">DOC_nd</span><span class="p">)</span>
                <span class="n">DOC_nd_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">DOC_nd_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">])</span>
                <span class="n">SAR_flatt</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">SAR</span><span class="p">)</span>
                <span class="n">SAR_df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">SAR_flatt</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span>


                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mach_df</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">passenger_capacity_df</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fuel_used_df</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mission_time_df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DOC_nd_df</span><span class="p">[</span><span class="s1">&#39;DOC_nd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">kpi_df3</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_df</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                <span class="n">kpi_df3</span><span class="o">=</span> <span class="n">kpi_df3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">kpi_df3</span><span class="p">[</span><span class="n">kpi_df3</span><span class="o">.</span><span class="n">distances01</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">kpi_df3</span> <span class="o">=</span> <span class="n">kpi_df3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">kpi_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">kpi_df2</span><span class="p">,</span><span class="n">kpi_df3</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
 
                <span class="c1"># Number of active nodes</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;active_arcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s2">&quot;aircraft_number&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;arcs_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;active_arcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="c1"># Number of aircraft</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># Average cruise mach</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;mach_tot_aircraft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;mach&#39;</span><span class="p">]</span>

                <span class="c1"># Total fuel</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_fuel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;fuel&#39;</span><span class="p">]</span>
                
                <span class="c1"># total CEMV</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_CEMV&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">aircraft</span><span class="p">[</span><span class="s1">&#39;wetted_area&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">0.24</span><span class="p">)))</span>
                
                <span class="c1"># Total distance</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span>

                <span class="c1"># Total pax</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_pax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;pax_num&#39;</span><span class="p">]</span>

                <span class="c1"># Total cost</span>
                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span>

                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;network_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;arcs_number&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;nodes_number&#39;</span><span class="p">])</span>

                <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;aircraft_number&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">kpi_df2</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; writting dataframes&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_optimal_results</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span> <span class="n">DOC_ik</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">,</span> <span class="n">kpi_df2</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_optimal_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_kml_results</span><span class="p">(</span><span class="n">arrivals</span><span class="p">,</span> <span class="n">departures</span><span class="p">,</span> <span class="n">profit</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_kml_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_newtork_results</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span><span class="n">kpi_df1</span><span class="p">,</span><span class="n">kpi_df2</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_newtork_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">write_unfeasible_results</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Aircraft did not pass sizing and checks, profit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>

            
    <span class="k">except</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; objective_function&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exception ocurred during calculations&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aircraft not passed sizing and checks, profit: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profit</span><span class="p">))</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_bad_results</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Error at &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; write_bad_results&quot;</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final individual results is:&quot;</span><span class="p">,</span> <span class="n">profit</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing finally clause&quot;</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Network profit excecution time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;==== End network profit module ====&#39;</span><span class="p">)</span>

    <span class="c1"># vehicle.clear()</span>

    <span class="k">return</span> <span class="n">profit</span></div>

<div class="viewcode-block" id="objective_function"><a class="viewcode-back" href="../../../framework.Optimization.html#framework.Optimization.objective_function_real.objective_function">[docs]</a><span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">operations</span> <span class="o">=</span> <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;operations&#39;</span><span class="p">]</span>
    <span class="c1"># operations[&#39;computation_mode&#39;] = 0</span>

    <span class="k">if</span> <span class="n">operations</span><span class="p">[</span><span class="s1">&#39;computation_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="n">objective_function_0</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">operations</span><span class="p">[</span><span class="s1">&#39;computation_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="n">objective_function_1</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profit</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># TEST</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># global NN_induced, NN_wave, NN_cd0, NN_CL, num_Alejandro</span>
<span class="c1"># num_Alejandro = 100000000000000000000000</span>
<span class="c1"># global NN_induced, NN_wave, NN_cd0, NN_CL</span>


<span class="c1"># from framework.Database.Aircrafts.baseline_aircraft_parameters import initialize_aircraft_parameters</span>

<span class="c1"># # # # # x = [130, 8.204561481970153, 0.3229876327660606, 31, -4, 0.3896951781733875, 4.826332970409506, 1.0650795018081771, 27, 1485, 1.6, 101, 4, 2185, 41000, 0.78, 1, 1, 1, 1]</span>
<span class="c1"># # # # # # x = [73, 8.210260198894748, 0.34131954092766925, 28, -5, 0.32042307969643524, 5.000456116634125, 1.337333818504011, 27, 1442, 1.6, 106, 6, 1979, 41000, 0.78, 1, 1, 1, 1]</span>
<span class="c1"># # # # # # x = [106, 9.208279852593964, 0.4714790814543369, 16, -3, 0.34987438995033143, 6.420120321538892, 1.7349297171205607, 29, 1461, 1.6, 74, 6, 1079, 41000, 0.78, 1, 1, 1, 1]</span>

<span class="c1"># # # # print(result)</span>
<span class="c1"># # # # x =[0, 77, 35, 19, -3, 33, 63, 17, 29, 1396, 25, 120, 6, 2280, 41000, 78]</span>

<span class="c1"># # # # result = objective_function(x, vehicle)</span>

<span class="c1"># # # # x = [103, 81, 40, 16, -4, 34, 59, 14, 29, 1370, 18, 114, 6, 1118]</span>


<span class="c1"># # # # x = [9.700e+01,9.900e+01,4.400e+01,1.800e+01,-2.000e+00,3.200e+01, 4.800e+01,1.400e+01,3.000e+01,1.462e+03,1.700e+01,6.000e+01, 6.000e+00,1.525e+03]</span>
<span class="c1"># # # # # x = [7.300e+01,8.600e+01,2.900e+01,1.600e+01,-5.000e+00,3.400e+01, 4.600e+01,2.000e+01,2.700e+01,1.372e+03,1.800e+01,1.160e+02, 4.000e+00,2.425e+03]</span>
<span class="c1"># # # # # x = [1.210e+02,9.600e+01,4.100e+01,2.600e+01,-3.000e+00,3.600e+01, 6.200e+01,1.800e+01,2.900e+01,1.478e+03,1.800e+01,6.800e+01, 5.000e+00,1.975e+03]</span>
<span class="c1"># # # # # x = [7.900e+01,9.400e+01,3.100e+01,2.000e+01,-4.000e+00,3.700e+01, 5.600e+01,1.000e+01,2.900e+01,1.448e+03,1.600e+01,8.200e+01, 5.000e+00,1.825e+03]</span>
<span class="c1"># # # # # x = [1.270e+02,7.600e+01,3.600e+01,2.800e+01,-4.000e+00,3.800e+01, 6.000e+01,1.800e+01,3.000e+01,1.432e+03,1.700e+01,8.800e+01, 5.000e+00,1.225e+03]</span>
<span class="c1"># # # # # x = [1.150e+02,8.400e+01,4.900e+01,3.200e+01,-2.000e+00,3.600e+01, 5.000e+01,1.400e+01,2.800e+01,1.492e+03,1.900e+01,1.100e+02, 4.000e+00,1.375e+03]</span>
<span class="c1"># # # # # x = [1.090e+02,8.100e+01,2.600e+01,2.400e+01,-5.000e+00,4.000e+01, 5.200e+01,1.600e+01,2.700e+01,1.402e+03,1.400e+01,7.400e+01, 4.000e+00,2.125e+03]</span>
<span class="c1"># # # # # x = [9.100e+01,8.900e+01,3.400e+01,3.000e+01,-3.000e+00,3.900e+01, 6.400e+01,1.200e+01,2.800e+01,1.358e+03,2.000e+01,9.600e+01, 5.000e+00,1.675e+03]</span>
<span class="c1"># # # # # x = [8.500e+01,9.100e+01,3.900e+01,3.400e+01,-3.000e+00,3.300e+01, 5.800e+01,1.200e+01,2.800e+01,1.418e+03,1.600e+01,1.020e+02, 6.000e+00,2.275e+03]</span>
<span class="c1"># # # # # x = [1.030e+02,7.900e+01,4.600e+01,2.200e+01,-4.000e+00,3.500e+01, 5.400e+01,1.600e+01,2.900e+01,1.388e+03,1.500e+01,5.400e+01, 6.000e+00,1.075e+03]</span>

<span class="c1"># # # # x = [1.150e+02,8.400e+01,4.900e+01,3.200e+01,-2.000e+00,3.600e+01, 5.000e+01,1.400e+01,2.800e+01,1.492e+03,1.900e+01,1.100e+02, 4.000e+00,1.375e+03,41000, 78, 1, 1, 1, 1] # Prifit ok</span>
<span class="c1"># # # # x =  [127, 82, 46, 22, -2, 44, 48, 21, 27, 1358, 22,  92, 5, 2875, 41200, 82, 1, 1, 1, 1]</span>
<span class="c1"># # # # x =  [115, 84, 49, 32, -2, 36, 50, 14, 28, 1492, 19, 110, 4, 1375, 41000, 78, 1, 1, 1, 1] #good one</span>
<span class="c1"># x =  [72, 86, 28, 26, -5, 34, 50, 13, 28, 1450, 14, 70, 4, 1600, 41000, 78, 1, 1, 1, 1] # Baseline</span>

<span class="c1"># # x =  [130, 91, 38, 29, -4.5, 33, 62, 17, 30, 1480, 18, 144, 6, 1900, 41000, 78, 1, 1, 1, 1] # 144 seat</span>
<span class="c1"># # x =  [121, 80, 40, 18, -2, 40, 52, 13, 28, 1358, 15, 108, 4, 1875, 41000, 82, 1, 1, 1, 1] # Baseline2</span>
<span class="c1"># # # # # # # x = [int(x) for x in x]</span>
<span class="c1"># # # # # # # print(x)</span>

<span class="c1"># # x =  [121, 114, 27, 25, -4.0, 35, 50, 14, 29, 1430, 23, 142, 6, 1171, 41000, 78, 1, 1, 1, 1] # Optim_Jose</span>

<span class="c1"># # # # # # x = [76, 118, 46, 23, -3, 33, 55, 19, 30, 1357, 18, 86, 6, 2412, 42260, 79, 1, 1, 1, 1]</span>
<span class="c1"># # # # # # x = [91, 108, 50, 29, -3, 34, 52, 12, 27, 1366, 19, 204, 4, 1812, 39260, 80, 1, 1, 1, 1]</span>
<span class="c1"># # # x = [110, 82, 34, 25, -5, 38, 52, 11, 30, 1462, 19, 92, 4, 1375, 39600, 80, 1, 1, 1, 1]</span>
<span class="c1"># # # # # vehicle = initialize_aircraft_parameters()</span>

<span class="c1"># # # x =[98,78,31,16,-4,40,61,20,28,1418,17,98,4,2005,41000,78,1,1,1,1]</span>
<span class="c1"># vehicle = initialize_aircraft_parameters()</span>
<span class="c1"># # # # start_time = datetime.now()</span>

<span class="c1"># result = objective_function(vehicle,x)</span>

<span class="c1"># # end_time = datetime.now()</span>
<span class="c1"># print(result)</span>


</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, gitificial.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>